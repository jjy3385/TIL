# 4강.이중모드, 하드웨어 보호

## 이중모드(dual mode)

* 한 컴퓨터를 여러 사람이 동시에 사용하는 환경이 일반적
  * 또는 한 사람이 여러 개의 프로그램을 동시에 사용
* 사용자 프로그램에서 STOP 등 치명적인 명령을 사용하지 못하게 해야함
* 그래서 나온것이 이중모드
  * 관리자 모드와 사용자 모드로 나뉨
* 프로세서 안에 있는 레지스터에 모드를 나타내는 플래그를 둬서 구현

###  이중모드 시나리오

* 운영체제 서비스가 실행될때는 **관리자 모드**
* 사용자 프로그램이 실행될때는 **사용자 모드**
* 하드웨서/소프트웨어 인터럽트가 발생하면 **관리자 모드**로 바뀌면서 OS가 ISR(인터럽스 서비스 루틴) 수행
  * 마우스에서  CPU에 전기신호로 인터럽트를 보내면 CPU는 바로 관리자 모드 플래그를 1로 바꾸면서 ISR로 점프하는 방식, 그러므로 OS가 ISR을 수행하는 동안은 관리자 모드 값이 1 인 거임
* ISR이 끝나면 **다시 사용자 모드**
* 그러므로 컴퓨터는 끊임없이 사용자 모드와 관리자 모드를 왔다갔다하면서 작업을 처리하게됨

> 💡만약, 사용자 프로그램에서 STOP 같은 관리자 모드에서 사용할 수 있는 명령어를 실행하게 되면?
>
> 그럴 경우, CPU는 관리자 모드가 아닌 것을 확인한 후 내부 인터럽트가 발생시킴
>
> 내부 인터럽트를 처리하는 OS의 ISR로 점프하여 해당 명령을 실행한 프로그램을 강제 종료
>
> 그러므로 서버 컴퓨터처럼 중요한 컴퓨터에 일반 유저가 접근하여 중요도가 높은 명령을 내릴 수 없도록 제어

## 하드웨어 보호(Protection)

###  입출력장치 보호

* 입력(IN) 또는 출력(OUT) 명령을 OS만 내릴 수 있는 특권명령으로 함으로써 입출력 장치도 보호될 수 있음
* 예를 들어, 사용자 A의 파일의 내용을 사용자 B가 수정/삭제 하려고 하면 OS 내부에서 잘못된 사용자의 잘못된 요청인 것을 파악하여 내부 인터럽트를 발생시킴, 항상 중간에서 일을 해주는건 OS 임
* 모든 입출력 관련명령을 특권명령으로 하여 보호함

### 메모리 보호

> 💡CPU 와 메모리 구조
> CPU 와 메모리는 address bus 와 data bus로 연결됨
> CPU는 메모리로 address bus 를 통해 읽으려는 주소를 보냄
> 그에 대한 응답으로 메모리는 data bus 를 통해 값을 전달함

* 메모리에 올라간 사용자 프로그램이 돌면서 다른 사용자 프로그램의 메모리 영역을 기웃거리거나 OS 메모리 영역의 코드를 바꾸려고 하는 행위를 막아야함(이게 해킹임)

#### 메모리 보호하는 법

* CPU 와 메모리 사이에 MMU (Memory Management Unit) 를 둔다
* MMU 에는 base 와 limit 레지스터가 있다
* base 와 limit 레지스터 값 사이에 존재하지 않는 영역(다른 메모리 영역)에 접근하려는 명령을 막고 인터럽트를 발생시킴
* MMU 의 레지스터 값 설정은 특권명령으로 OS만이 할  수 있음

### CPU 보호

* 한 사용자가 CPU 시간을 독점하는 경우, 다른 사용자는 CPU 사용 불가

  * ex) `while(n=1){...}`

* 해결방법

  * 타이머를 두어 일정 시간 경과 시 타이머 인터럽트를 발생시킴
  * 해당 ISR은 다른 프로그램으로 강제 전환되고 CPU 를 혼자 독점하고 있는 프로그램이 있는지 감시함

  ​